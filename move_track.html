<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthX - AI Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%); color: #1e293b; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); }
        #flash-overlay { position: absolute; inset: 0; background: white; opacity: 0; pointer-events: none; z-index: 60; transition: opacity 0.2s; }
        canvas { width: 100%; height: auto; border-radius: 12px; background: #000; transform: scaleX(-1); }
        video { transform: scaleX(-1); }
    </style>
</head>
<body class="flex flex-col h-screen">

    <nav class="bg-white border-b border-gray-100 px-6 py-4 shadow-sm flex-none">
        <div class="max-w-7xl mx-auto flex items-center justify-between w-full">
            <div class="flex items-center gap-2">
                <a href="<?= getScriptUrl() ?>?page=index" class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-gray-600 transition">‚Üê Back</a>
                <div class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center text-white font-bold ml-2">H</div>
                <h1 class="text-2xl font-bold text-gray-800 tracking-tight">Health<span class="text-emerald-500">X</span></h1>
            </div>
            <div class="text-sm font-medium text-gray-500 hidden sm:block">AI Movement Assistant</div>
        </div>
    </nav>

    <div id="flash-overlay"></div>

    <div class="flex-1 p-4 lg:p-8 overflow-y-auto">
        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8 h-full">
            
            <div class="flex flex-col gap-4">
                <div class="glass-card rounded-2xl p-6 h-full flex flex-col">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="w-2 h-6 bg-emerald-500 rounded-full"></span> Instructor View
                    </h2>
                    <div class="relative w-full pb-[56.25%] rounded-xl overflow-hidden shadow-lg bg-black h-full">
                         <iframe id="yt-player" class="absolute top-0 left-0 w-full h-full" src="https://www.youtube.com/embed/g_tea8ZNk5A?si=defaults" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-4">
                <div class="glass-card rounded-2xl p-6 h-full relative">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <span class="w-2 h-6 bg-emerald-500 rounded-full"></span> Your Form
                        </h2>
                        <span id="status-badge" class="px-3 py-1 bg-gray-100 text-gray-500 rounded-full text-xs font-bold uppercase tracking-wide border border-gray-200">Initializing...</span>
                    </div>

                    <div class="relative rounded-xl overflow-hidden shadow-lg bg-slate-900 aspect-video flex items-center justify-center">
                        <video id="video" playsinline style="display:none;"></video>
                        <canvas id="output"></canvas>
                        <div id="upload-overlay" class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white hidden">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500 mb-2"></div>
                            <span class="text-sm font-medium">Saving to Drive...</span>
                        </div>
                    </div>

                    <div class="mt-6 grid grid-cols-2 gap-4">
                        <div class="bg-emerald-50 rounded-xl p-4 border border-emerald-100">
                            <div class="text-xs text-emerald-600 font-semibold uppercase mb-1">Session Photos</div>
                            <div class="text-2xl font-bold text-emerald-800" id="photo-count">0</div>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                            <div class="text-xs text-gray-500 font-semibold uppercase mb-1">Latest Action</div>
                            <div class="text-sm font-medium text-gray-700 truncate" id="last-action">None</div>
                        </div>
                    </div>
                    <div id="upload-status" class="text-xs text-center mt-2 h-4 text-emerald-600 font-medium"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const VIDEO_WIDTH = 640;
        const VIDEO_HEIGHT = 480;
        let detector, video, canvas, ctx;
        let lastCaptureTime = 0;
        const COOLDOWN_MS = 5000;
        let isUploading = false;
        let photoCount = 0;

        const THEME = { skeleton: '#10b981', keypoint: '#ffffff', keypointBorder: '#059669' };

        async function init() {
            video = document.getElementById('video');
            canvas = document.getElementById('output');
            ctx = canvas.getContext('2d');
            await setupCamera();
            const detectorConfig = { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING };
            detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, detectorConfig);
            detectPose();
        }

        async function setupCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ 'audio': false, 'video': { facingMode: 'user', width: VIDEO_WIDTH, height: VIDEO_HEIGHT } });
            video.srcObject = stream;
            return new Promise((resolve) => {
                video.onloadedmetadata = () => {
                    video.play();
                    canvas.width = VIDEO_WIDTH;
                    canvas.height = VIDEO_HEIGHT;
                    resolve(video);
                };
            });
        }

        async function detectPose() {
            if (!detector) return;
            const poses = await detector.estimatePoses(video);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            if (poses.length > 0) {
                const kp = poses[0].keypoints;
                drawSkeleton(kp); 
                checkTriggers(kp);
            }
            requestAnimationFrame(detectPose);
        }

        function checkTriggers(keypoints) {
            const getVal = (name, axis) => {
                const p = keypoints.find(k => k.name === name);
                return (p && p.score > 0.3) ? p[axis] : null;
            };
            const getY = (n) => getVal(n, 'y');
            const getX = (n) => getVal(n, 'x');

            const noseY = getY('nose');
            const lwY = getY('left_wrist'); const lwX = getX('left_wrist');
            const rwY = getY('right_wrist'); const rwX = getX('right_wrist');
            const lsY = getY('left_shoulder'); const rsY = getY('right_shoulder');
            const lKneeY = getY('left_knee'); const rKneeY = getY('right_knee');
            
            const statusBadge = document.getElementById('status-badge');
            let detectedAction = null;

            // 1. HANDS UP
            if (noseY && lwY && rwY && lwY < noseY && rwY < noseY) { detectedAction = "HANDS UP! üôå"; }
            // 2. T-POSE
            else if (lwY && rwY && lsY && rsY && lwX && rwX && Math.abs(lwY - lsY) < 60 && Math.abs(rwY - rsY) < 60 && Math.abs(lwX - rwX) > 150) { detectedAction = "T-POSE ‚úàÔ∏è"; }
            // 3. KNEE TOUCH
            else if ((lwY && lKneeY && Math.abs(lwY - lKneeY) < 80) || (rwY && rKneeY && Math.abs(rwY - rKneeY) < 80)) { detectedAction = "KNEE TOUCH üßò"; }

            if (detectedAction) {
                statusBadge.innerText = detectedAction;
                statusBadge.className = "px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold uppercase tracking-wide border border-emerald-200";
                triggerCapture(detectedAction);
            } else {
                statusBadge.innerText = "Scanning...";
                statusBadge.className = "px-3 py-1 bg-gray-100 text-gray-500 rounded-full text-xs font-bold uppercase tracking-wide border border-gray-200";
            }
        }

        function triggerCapture(actionName) {
            const now = Date.now();
            if (now - lastCaptureTime > COOLDOWN_MS && !isUploading) {
                lastCaptureTime = now;
                takePhoto(actionName);
            }
        }

        function takePhoto(actionName) {
            isUploading = true;
            document.getElementById('upload-overlay').classList.remove('hidden');
            document.getElementById('last-action').innerText = actionName;
            
            const flash = document.getElementById('flash-overlay');
            flash.style.opacity = '0.5';
            setTimeout(() => flash.style.opacity = '0', 200);

            const dataUrl = canvas.toDataURL('image/png');

            google.script.run
                .withSuccessHandler(onUploadSuccess)
                .withFailureHandler(onUploadFailure)
                .processCapture(dataUrl, actionName);
        }

        function onUploadSuccess(response) {
            isUploading = false;
            document.getElementById('upload-overlay').classList.add('hidden');
            if (response.success) {
                photoCount++;
                document.getElementById('photo-count').innerText = photoCount;
                document.getElementById('upload-status').innerText = "‚úì Saved to Drive";
                setTimeout(() => document.getElementById('upload-status').innerText = "", 3000);
            } else {
                document.getElementById('upload-status').innerText = "Error: " + response.error;
            }
        }

        function onUploadFailure(error) {
            isUploading = false;
            document.getElementById('upload-overlay').classList.add('hidden');
            document.getElementById('upload-status').innerText = "Connection Failed";
        }

        function drawSkeleton(keypoints) {
            const connections = [
                ['nose', 'left_eye'], ['nose', 'right_eye'], ['left_shoulder', 'right_shoulder'],
                ['left_shoulder', 'left_elbow'], ['right_shoulder', 'right_elbow'],
                ['left_elbow', 'left_wrist'], ['right_elbow', 'right_wrist'],
                ['left_shoulder', 'left_hip'], ['right_shoulder', 'right_hip'],
                ['left_hip', 'right_hip'], ['left_hip', 'left_knee'], ['right_hip', 'right_knee']
            ];
            const getPoint = (name) => {
                const kp = keypoints.find(k => k.name === name);
                return kp && kp.score > 0.3 ? { x: kp.x, y: kp.y } : null;
            };
            ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.strokeStyle = THEME.skeleton;
            connections.forEach(([p1, p2]) => {
                const a = getPoint(p1); const b = getPoint(p2);
                if(a && b) { ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke(); }
            });
            keypoints.forEach(p => {
                if (p.score > 0.3) {
                    ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, 2*Math.PI);
                    ctx.fillStyle = THEME.keypoint; ctx.fill();
                    ctx.strokeStyle = THEME.keypointBorder; ctx.lineWidth = 2; ctx.stroke();
                }
            });
        }
        window.onload = init;
    </script>
</body>
</html>
